#!/bin/sh
# mise description="claue --verbose --output-format stream-json -p ''"

RESET=$'\e[0m'
BOLD=$'\e[1m'
GREEN=$'\e[32m'
CYAN=$'\e[36m'
RED=$'\e[31m'

claude --verbose --output-format stream-json -p "${@}" | while IFS= read -r line; do
  role=$(jq -r '.message?.role // .type // "unknown"' <<<"$line")
  type=$(jq -r '.type // "n/a"' <<<"$line")
  msg=$(jq -r '.message?.content?[0]?.text // .result // ""' <<<"$line")
  dur=$(jq -r '.duration_ms // .duration_api_ms // "?"' <<<"$line")
  cost=$(jq -r '.total_cost_usd // "0"' <<<"$line")

  case "$role" in
    system)
      echo "${CYAN}[SYSTEM]${RESET} ($type) dur:${dur}ms cost:${cost}"
      ;;
    assistant)
      echo "${GREEN}[ASSIST]${RESET} $msg"
      ;;
    result)
      echo "${BOLD}[RESULT]${RESET} dur:${dur}ms cost:${cost}"
      ;;
    error|fail|*ERR*)
      echo "${RED}[ERROR]${RESET} $msg"
      ;;
    *)
      echo "[LOG] role:$role type:$type msg:$msg"
      ;;
  esac
done
