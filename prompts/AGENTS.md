# Claude 글로벌 설정

프로세스 관리: @rules/process-management.md

---

# Context 관리

## Context Window 보호

**200k 토큰 한계 인식**:
- MCP 과다 등록 시 → 실사용 **70k까지 감소**
- 프로젝트당 MCP **5-6개만 활성화**
- 활성 도구 **80개 미만** 유지
- 불필요 MCP → `settings.json`에서 비활성화

## Subagent 결과 압축

| subagent | 반환 형식 |
|----------|----------|
| Explore | 파일 경로 + 핵심 의존성 (1-3개) |
| Plan | 구현 순서 + 트레이드오프 |
| Bash | 성공/실패 + 에러 상위 3개 |
| code-reviewer | Summary + Critical/High만 |

**압축 원칙**:
- 상세 정보 → **파일 저장 후 경로만 전달**
- 대용량 출력 → 요약 후 보고
- 전체 코드 복사 금지 → **파일 경로:라인 번호** 형식

---

# 개발 핵심 원칙

## 리팩토링 안전망

리팩토링(함수 이름 변경, 시그니처 변경, 코드 이동)은 **파일 단위로 검증**한다:

0. 변경 전 전체 테스트를 실행하여 **베이스라인(통과 수)을 기록**한다
1. 파일 하나를 수정한다
2. 관련 테스트를 즉시 실행한다
3. 실패가 있으면 **그 자리에서 수정**한다
4. 통과 수가 베이스라인 이상일 때만 다음 파일로 넘어간다
5. 모든 파일 완료 후 전체 테스트를 실행하여 **before/after 요약을 보고**한다

**테스트가 깨진 상태로 다음 파일로 진행하지 않는다.** 변경을 일괄 처리하고 마지막에 몰아서 테스트하는 것을 금지한다. 대규모 리팩토링 시 Task로 테스트 실행을 병렬화한다.

## 디버깅 자세

사용자에게 재시작이나 수동 개입을 제안하지 않는다. Bash 접근이 가능하므로:

1. 관련 코드를 읽어 **초기화/실행 경로를 추적**한다
2. **직접 문제를 재현**한다 (서버 실행, 실패 명령 실행)
3. **가설을 세우고, 수정하고, 재검증**한다
4. 해결될 때까지 2-3을 반복한다 (최대 10회)
5. 완료 시 **근본 원인과 diff 요약을 보고**한다

"재시작해 보세요", "수동으로 확인해 주세요" 등의 회피성 제안을 금지한다. 표면적 진단에서 멈추지 말고 근본 원인까지 추적한다.

## 코드 생성 전 컨텍스트 확인

새 코드를 작성하기 전에 반드시:

1. **올바른 저장소**에서 작업 중인지 확인
2. 기존 테스트 설정, 라우터 구성, **기존 파일 최소 2개를 읽어** 컨벤션 파악
3. 파악한 내용(기술 스택, 라우터 타입, 테스트 프레임워크, strict 모드 등)을 **나열한 뒤** 코드 작성 시작

확인 없이 바로 코드를 생성하지 않는다.

## Hooks 활용

리팩토링 작업 시 프로젝트의 `.claude/settings.json`에 postToolUse hook을 설정하여 테스트 실패를 조기 발견한다.

1. 프로젝트의 테스트 명령을 확인 (justfile, package.json, pyproject.toml 등)
2. 해당 명령으로 적절한 hook을 `.claude/settings.json`에 설정
3. 작업 완료 후 hook 제거 여부는 사용자에게 확인

```jsonc
// .claude/settings.json 예시
{
  "hooks": {
    "postToolUse": [
      {
        "matcher": "Edit|Write",
        "command": "<프로젝트 테스트 명령> --tb=short -q 2>&1 | tail -5 || true"
      }
    ]
  }
}
```

---

# Custom Agent 위임

다음 조건에서 커스텀 agent를 **즉시 위임**한다:

| 조건 | Agent |
|------|-------|
| 코드 변경 2+ 파일 완료 | `code-reviewer` (Python/TS skill 자동 주입) |
| 기능 요청 수신, 요구사항 모호 | `spec-validator` |
| 테스트 통과 후 | `test-verifier` |
| 반복 패턴 3회+ 감지 | `skill-suggester` |
| 작업 단계 완료, 커밋 전 | `tidy-commit` |

**위임 원칙**:
- description에 "PROACTIVELY"가 있는 agent는 사용자 요청 없이도 위임
- 리뷰 계열 agent는 백그라운드로 실행 가능
- 위임 결과는 압축하여 반환 (Summary + Critical/High만)

---

# Skill 우선 활용 (Skill-First)

**적합한 Skill 있으면 사용**. 미사용은 예외.

- 대부분의 작업에 적합한 skill 존재. 없다면 생성을 제안
- 예시: 테스트 먼저 → tdd-practices, 계획 수립 → plan-creator
