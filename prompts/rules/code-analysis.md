코드 분석 시 컨텍스트를 최적화하여 토큰 소모를 줄이고 정확도를 높입니다.

## 계층적 분석 (Layered Analysis)

모든 코드를 읽지 않습니다. 단계별로 필요한 만큼만 깊이 들어갑니다.

```
Level 1: 구조 파악 (파일명, 디렉토리)
   ↓ 타겟 식별
Level 2: 시그니처 분석 (함수명, 클래스명, export)
   ↓ 관련 부분 특정
Level 3: 상세 코드 (실제 구현)
```

## 도구 선택 우선순위

| 목적 | 도구 | 이유 |
|------|------|------|
| 구조 파악 | `Glob`, `ls -la` | 파일명만으로 판단 |
| 패턴 검색 | `ast-grep` | 구조적 검색, 정밀한 결과 |
| 텍스트 검색 | `Grep` | 빠르지만 노이즈 많음 |
| 상세 분석 | `Read` (부분) | offset/limit 활용 |

## ast-grep 활용

텍스트 매칭 대신 AST 패턴으로 정확한 결과만 취득.

**직접 사용** (간단한 패턴):
```bash
# 함수 정의 찾기
ast-grep --lang typescript -p 'function $NAME($$$) { $$$ }'

# 특정 import 찾기
ast-grep --lang typescript -p 'import { $_ } from "react"'
```

**`ast-grep` skill 호출** (복잡한 경우):
- 리팩토링 (`-r` 옵션)
- 언어별 특수 구문 (Python 데코레이터, Go 인터페이스)
- 조건부 매칭, 다중 메타변수 조합

## 파일 크기별 전략

- **< 200줄**: 전체 Read 허용
- **200-500줄**: 시그니처만 먼저 (`head -50`), 필요 시 부분 Read
- **500줄+**: 반드시 subagent에 위임하거나 ast-grep 사용

## Subagent 위임 기준

다음 상황에서 즉시 `[위임: Explore]` 사용:

- 3개 이상 파일 탐색 필요
- "어디서", "어떻게" 등 탐색적 질문
- 코드베이스 구조 파악
- 의존성 추적

```
# 잘못된 예
Grep → Read → Read → Read... (컨텍스트 소모)

# 올바른 예
[위임: Explore, "X 관련 파일 분석"] → 요약 결과 → 필요 시 타겟 Read
```

**Explore 프롬프트 작성 요령**:
- 목표를 명확히: "X 함수의 호출 관계 분석"
- 반환 형식 지정: "파일경로:라인 형식으로 요약"
- 범위 제한: "src/ 디렉토리 내에서"

## 검증 작업 위임

test, build, lint 등 출력이 긴 작업은 subagent에 위임하여 컨텍스트를 보존합니다.

| 작업 | 직접 실행 | subagent 위임 |
|------|:---------:|:-------------:|
| 단일 파일 테스트 | ✓ | |
| 전체 테스트 | | ✓ |
| 빌드 | | ✓ |
| lint / type-check | | ✓ |

**반환 포맷**:
- 성공: `✓ 테스트 통과 (42 passed)`
- 실패: `✗ 3개 실패` + 상위 5개 에러 요약 (파일:라인 - 메시지)

```
# 잘못된 예
Bash: npm test  (출력 수백 줄 → 컨텍스트 소모)

# 올바른 예
[위임: Bash, "npm test 실행 후 결과 요약. 성공 시 통과 개수만, 실패 시 상위 5개 에러"]
→ "✓ 전체 통과 (42 passed)" 또는 "✗ 3개 실패: [요약]"
```

## 외부 도구 활용

복잡한 분석은 도구에 위임하고 결과만 가져옵니다:

```bash
# 의존성 그래프
madge --circular src/

# 타입 검사
tsc --noEmit 2>&1 | head -20

# 코드 복잡도
npx es-check es6 src/**/*.js --verbose | head -30
```

## Anti-patterns

- 전체 파일을 순차적으로 Read하며 탐색
- grep 결과 전체를 컨텍스트에 적재
- 500줄+ 파일을 subagent 없이 분석
- 구조 파악 없이 바로 상세 코드로 진입
- 전체 테스트/빌드를 메인 컨텍스트에서 직접 실행
