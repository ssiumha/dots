#!/bin/bash
# jd health - JD ë¬¸ì„œ ê±´ê°•ë„ ì²´í¬
set -euo pipefail

DOCS_DIR="${DOCS_DIR:-docs}"
STALE_DAYS="${STALE_DAYS:-180}"

usage() {
  echo "Usage: jd health [--fix]"
  echo ""
  echo "Options:"
  echo "  --fix    ìë™ ìˆ˜ì • ê°€ëŠ¥í•œ í•­ëª© ìˆ˜ì •"
}

jdex="$DOCS_DIR/00-09-System/00-Index/00.00-jdex.md"

check_jdex() {
  if [[ ! -f "$jdex" ]]; then
    echo "JDex not found: $jdex" >&2
    exit 1
  fi
}

# íŒŒì¼ ì‹œìŠ¤í…œì—ì„œ ëª¨ë“  JD ë¬¸ì„œ ì°¾ê¸°
find_docs() {
  find "$DOCS_DIR" -name "*.md" -path "*/[0-9][0-9]-*/*" \
    | grep -E '/[0-9]{2}\.[0-9]{2}-' \
    | grep -v "/01-Templates/" \
    | sort
}

# frontmatter ì¶”ì¶œ
get_frontmatter() {
  local file="$1"
  sed -n '/^---$/,/^---$/p' "$file" 2>/dev/null | head -20
}

# frontmatter í•„ë“œ ê°’ ì¶”ì¶œ
get_field() {
  local fm="$1"
  local field="$2"
  echo "$fm" | grep -E "^$field:" | sed "s/^$field:[[:space:]]*//" | tr -d '"'
}

fix_mode=false
[[ "${1:-}" == "--fix" ]] && fix_mode=true

check_jdex

echo "ğŸ¥ JD ë¬¸ì„œ ê±´ê°•ë„ ì²´í¬"
echo ""

errors=0
warnings=0

# 1. JDex ë™ê¸°í™” ê²€ì‚¬
echo "## JDex ë™ê¸°í™”"
while IFS= read -r file; do
  basename=$(basename "$file" .md)
  doc_id=$(echo "$basename" | grep -oE '^[0-9]{2}\.[0-9]{2}')

  if ! grep -q "^- $doc_id" "$jdex" 2>/dev/null; then
    echo "  âš ï¸  JDex ëˆ„ë½: $doc_id"
    ((warnings++)) || true
  fi
done < <(find_docs)

# 2. Frontmatter ê²€ì‚¬
echo ""
echo "## Frontmatter ê²€ì‚¬"

required_fields=("id" "title" "status" "date")

while IFS= read -r file; do
  fm=$(get_frontmatter "$file")
  basename=$(basename "$file" .md)

  if [[ -z "$fm" ]]; then
    echo "  âŒ frontmatter ì—†ìŒ: $basename"
    ((errors++)) || true
    continue
  fi

  for field in "${required_fields[@]}"; do
    value=$(get_field "$fm" "$field")
    if [[ -z "$value" ]]; then
      echo "  âš ï¸  $field ëˆ„ë½: $basename"
      ((warnings++)) || true
    fi
  done

  # ID ì¼ì¹˜ ê²€ì‚¬
  fm_id=$(get_field "$fm" "id")
  file_id=$(echo "$basename" | grep -oE '^[0-9]{2}\.[0-9]{2}')
  if [[ -n "$fm_id" && "$fm_id" != "$file_id" ]]; then
    echo "  âŒ ID ë¶ˆì¼ì¹˜: $basename (íŒŒì¼: $file_id, frontmatter: $fm_id)"
    ((errors++)) || true
  fi
done < <(find_docs)

# 3. ì˜¤ë˜ëœ ë¬¸ì„œ ê²€ì‚¬
echo ""
echo "## ì˜¤ë˜ëœ ë¬¸ì„œ (${STALE_DAYS}ì¼+)"

stale_cutoff=$(date -v-${STALE_DAYS}d +%Y-%m-%d 2>/dev/null || date -d "${STALE_DAYS} days ago" +%Y-%m-%d)

while IFS= read -r file; do
  fm=$(get_frontmatter "$file")
  update_date=$(get_field "$fm" "updated")
  [[ -z "$update_date" ]] && update_date=$(get_field "$fm" "date")

  if [[ -n "$update_date" && "$update_date" < "$stale_cutoff" ]]; then
    basename=$(basename "$file" .md)
    echo "  ğŸ“… $basename (ë§ˆì§€ë§‰ ìˆ˜ì •: $update_date)"
    ((warnings++)) || true
  fi
done < <(find_docs)

# 4. ìƒíƒœ ê²€ì‚¬
echo ""
echo "## ìƒíƒœ ê²€ì‚¬"

valid_statuses="draft|review|approved|active|deprecated|superseded|archived|proposed|accepted|rejected|withdrawn|investigating|identified|monitoring|resolved"

while IFS= read -r file; do
  fm=$(get_frontmatter "$file")
  status=$(get_field "$fm" "status")

  if [[ -n "$status" ]] && ! echo "$status" | grep -qE "^($valid_statuses)$"; then
    basename=$(basename "$file" .md)
    echo "  âš ï¸  ì˜ëª»ëœ ìƒíƒœ: $basename ($status)"
    ((warnings++)) || true
  fi
done < <(find_docs)

# ìš”ì•½
echo ""
echo "---"
echo "## ìš”ì•½"
total_docs=$(find_docs | wc -l | tr -d ' ')
echo "  ğŸ“„ ì´ ë¬¸ì„œ: $total_docs"
echo "  âŒ ì˜¤ë¥˜: $errors"
echo "  âš ï¸  ê²½ê³ : $warnings"

if [[ $fix_mode == true && $warnings -gt 0 ]]; then
  echo ""
  echo "ğŸ”§ ìë™ ìˆ˜ì • ì‹¤í–‰ ì¤‘..."
  # JDex ë™ê¸°í™”
  "$(dirname "$0")/index" update
  echo "âœ… ìˆ˜ì • ì™„ë£Œ"
fi

if [[ $errors -gt 0 ]]; then
  exit 1
elif [[ $warnings -gt 0 ]]; then
  exit 0
else
  echo ""
  echo "âœ… ëª¨ë“  ê²€ì‚¬ í†µê³¼"
fi
