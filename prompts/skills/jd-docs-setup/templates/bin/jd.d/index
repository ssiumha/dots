#!/bin/bash
# jd index - JDex ì¸ë±ìŠ¤ ê´€ë¦¬
set -euo pipefail

DOCS_DIR="${DOCS_DIR:-docs}"

usage() {
  echo "Usage: jd index <action>"
  echo ""
  echo "Actions:"
  echo "  update   JDexë¥¼ íŒŒì¼ ì‹œìŠ¤í…œê³¼ ë™ê¸°í™”"
  echo "  check    ì¼ê´€ì„± ê²€ì‚¬"
  echo "  list     ë¬¸ì„œ ëª©ë¡ ì¶œë ¥"
}

jdex="$DOCS_DIR/00-09-System/00-Index/00.00-jdex.md"

check_jdex() {
  if [[ ! -f "$jdex" ]]; then
    echo "JDex not found: $jdex" >&2
    echo "Run '/jd-docs-setup init' first." >&2
    exit 1
  fi
}

# íŒŒì¼ ì‹œìŠ¤í…œì—ì„œ ëª¨ë“  JD ë¬¸ì„œ ì°¾ê¸°
find_docs() {
  find "$DOCS_DIR" -name "*.md" -path "*/[0-9][0-9]-*/*" \
    | grep -E '/[0-9]{2}\.[0-9]{2}-' \
    | sort
}

# JDexì—ì„œ ëª¨ë“  í•­ëª© ì¶”ì¶œ
jdex_entries() {
  grep -E "^- [0-9]{2}\.[0-9]{2}" "$jdex" | sed 's/^- //' | sort
}

action="${1:-}"

case "$action" in
  update)
    check_jdex
    echo "ğŸ”„ JDex ë™ê¸°í™” ì¤‘..."

    # íŒŒì¼ ì‹œìŠ¤í…œì˜ ë¬¸ì„œ ëª©ë¡
    fs_docs=$(find_docs)

    # ëˆ„ë½ëœ í•­ëª© ìˆ˜ì§‘ ë° ì¶”ê°€
    added=0
    additions=""
    while IFS= read -r file; do
      [[ -z "$file" ]] && continue
      basename=$(basename "$file" .md)
      doc_id=$(echo "$basename" | grep -oE '^[0-9]{2}\.[0-9]{2}')
      title=$(echo "$basename" | sed "s/^$doc_id-//" | tr '-' ' ')

      if ! grep -q "^- $doc_id" "$jdex"; then
        echo "  + $doc_id $title"
        additions="${additions}- $doc_id $title\n"
        ((added++)) || true
      fi
    done <<< "$fs_docs"

    # JDexì— ëˆ„ë½ í•­ëª© ì¶”ê°€ (íŒŒì¼ ëì—)
    if [[ -n "$additions" ]]; then
      echo "" >> "$jdex"
      echo "## ë¯¸ë¶„ë¥˜ (ìë™ ì¶”ê°€)" >> "$jdex"
      echo -e "$additions" >> "$jdex"
    fi

    # í†µê³„ ì—…ë°ì´íŠ¸
    count=$(echo "$fs_docs" | grep -c . 2>/dev/null || echo 0)
    today=$(date +%Y-%m-%d)
    sed -i.bak \
      -e "s/{{DATE}}/$today/" \
      -e "s/{{COUNT}}/$count/" \
      -e "s/ìµœì¢… ìˆ˜ì •: [0-9-]*/ìµœì¢… ìˆ˜ì •: $today/" \
      -e "s/ì´ ë¬¸ì„œ ìˆ˜: [0-9]*/ì´ ë¬¸ì„œ ìˆ˜: $count/" \
      "$jdex" && rm -f "$jdex.bak"

    echo "âœ… ë™ê¸°í™” ì™„ë£Œ (ì¶”ê°€: $added, ì´: $count)"
    ;;

  check)
    check_jdex
    echo "ğŸ” ì¼ê´€ì„± ê²€ì‚¬ ì¤‘..."

    errors=0

    # JDexì— ìˆì§€ë§Œ íŒŒì¼ ì—†ìŒ
    while IFS= read -r entry; do
      doc_id=$(echo "$entry" | grep -oE '^[0-9]{2}\.[0-9]{2}')
      if ! find "$DOCS_DIR" -name "$doc_id-*.md" | grep -q .; then
        echo "  âš ï¸  íŒŒì¼ ì—†ìŒ: $entry"
        ((errors++)) || true
      fi
    done < <(jdex_entries)

    # íŒŒì¼ ìˆì§€ë§Œ JDexì— ì—†ìŒ
    while IFS= read -r file; do
      basename=$(basename "$file" .md)
      doc_id=$(echo "$basename" | grep -oE '^[0-9]{2}\.[0-9]{2}')
      if ! grep -q "^- $doc_id" "$jdex"; then
        echo "  âš ï¸  JDex ëˆ„ë½: $doc_id ($(basename "$file"))"
        ((errors++)) || true
      fi
    done < <(find_docs)

    if [[ $errors -eq 0 ]]; then
      echo "âœ… ì¼ê´€ì„± ê²€ì‚¬ í†µê³¼"
    else
      echo "âŒ $errorsê°œ ì´ìŠˆ ë°œê²¬"
      echo "   'jd index update' ì‹¤í–‰ìœ¼ë¡œ ë™ê¸°í™”í•˜ì„¸ìš”."
      exit 1
    fi
    ;;

  list)
    check_jdex
    echo "ğŸ“‹ ë¬¸ì„œ ëª©ë¡"
    echo ""

    current_area=""
    current_cat=""

    while IFS= read -r file; do
      [[ -z "$file" ]] && continue
      # ì˜ì—­/ì¹´í…Œê³ ë¦¬ ì¶”ì¶œ
      area=$(echo "$file" | grep -oE '/[0-9]{2}-[0-9]{2}-[^/]+' | head -1 | tr -d '/')
      cat=$(echo "$file" | grep -oE '/[0-9]{2}-[^/]+' | tail -1 | tr -d '/')

      if [[ "$area" != "$current_area" ]]; then
        echo ""
        echo "## $area"
        current_area="$area"
        current_cat=""
      fi

      if [[ "$cat" != "$current_cat" ]]; then
        echo ""
        echo "### $cat"
        current_cat="$cat"
      fi

      basename=$(basename "$file" .md)
      echo "- $basename"
    done < <(find_docs)
    ;;

  *)
    usage
    exit 1
    ;;
esac
