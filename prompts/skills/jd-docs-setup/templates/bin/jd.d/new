#!/bin/bash
# jd new - JD ë¬¸ì„œ ìƒì„±
set -euo pipefail

DOCS_DIR="${DOCS_DIR:-docs}"

# ë¬¸ì„œ ìœ í˜• â†’ ì˜ì—­:ì¹´í…Œê³ ë¦¬:í…œí”Œë¦¿ ë§¤í•‘
get_type_map() {
  case "$1" in
    adr)           echo "20-29-Architecture:21-ADR:01.01-adr.md" ;;
    design)        echo "20-29-Architecture:22-System-Design:01.03-system-design.md" ;;
    rfc)           echo "20-29-Architecture:25-RFC:01.04-rfc.md" ;;
    api)           echo "30-39-API:31-REST-API:01.02-api-rest.md" ;;
    requirement)   echo "50-59-Process:51-Requirements:01.05-requirement.md" ;;
    meeting)       echo "50-59-Process:53-Meetings:01.06-meeting.md" ;;
    retrospective) echo "50-59-Process:54-Retrospectives:01.07-retrospective.md" ;;
    incident)      echo "60-69-Operations:63-Incidents:01.08-incident.md" ;;
    runbook)       echo "60-69-Operations:64-Runbooks:01.09-runbook.md" ;;
    troubleshoot)  echo "70-79-Knowledge:71-Troubleshooting:01.10-troubleshooting.md" ;;
    *) return 1 ;;
  esac
}

usage() {
  cat <<EOF
Usage: jd new <type> "<title>"

Types:
  adr            Architecture Decision Record
  design         System Design Document
  rfc            Request for Comments
  api            REST API Documentation
  requirement    Requirements Specification
  meeting        Meeting Notes
  retrospective  Retrospective
  incident       Incident Report
  runbook        Runbook
  troubleshoot   Troubleshooting Guide

Examples:
  jd new adr "Database Selection"
  jd new incident "Server Outage"
EOF
}

# ì¸ì í™•ì¸
if [[ $# -lt 1 ]]; then
  usage
  exit 1
fi

type="$1"
title="${2:-}"

# ìœ í˜• í™•ì¸
mapping=$(get_type_map "$type" 2>/dev/null) || {
  echo "Unknown type: $type" >&2
  echo ""
  usage
  exit 1
}

# ì œëª© ì…ë ¥ (ëŒ€í™”í˜•)
if [[ -z "$title" ]]; then
  read -rp "ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”: " title
  if [[ -z "$title" ]]; then
    echo "ì œëª©ì´ í•„ìš”í•©ë‹ˆë‹¤." >&2
    exit 1
  fi
fi

# ë§¤í•‘ íŒŒì‹±
IFS=':' read -r area category template <<< "$mapping"
cat_num="${category%%-*}"  # 21-ADR â†’ 21

# JDex ê²½ë¡œ
jdex="$DOCS_DIR/00-09-System/00-Index/00.00-jdex.md"
if [[ ! -f "$jdex" ]]; then
  echo "JDex not found: $jdex" >&2
  echo "Run '/jd-docs-setup init' first." >&2
  exit 1
fi

# ë§ˆì§€ë§‰ ID ì°¾ê¸°
last_id=$(grep -E "^- $cat_num\.[0-9]{2}" "$jdex" 2>/dev/null | tail -1 | sed 's/.*\.\([0-9][0-9]\).*/\1/' || echo "09")
if [[ -z "$last_id" || ! "$last_id" =~ ^[0-9]+$ ]]; then
  last_id="09"
fi
next_id=$(printf "%02d" $((10#$last_id + 1)))

# 10 ë¯¸ë§Œì´ë©´ 10ë¶€í„° ì‹œì‘ (Standard Zeros ì˜ˆì•½)
if [[ $((10#$next_id)) -lt 10 ]]; then
  next_id="10"
fi

# slug ìƒì„±
slug=$(echo "$title" | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | tr -cd 'a-z0-9-')

# ê²½ë¡œ êµ¬ì„±
doc_id="$cat_num.$next_id"
filename="$doc_id-$slug.md"
dir_path="$DOCS_DIR/$area/$category"
file_path="$dir_path/$filename"

# ì¹´í…Œê³ ë¦¬ ë””ë ‰í† ë¦¬ ìƒì„±
mkdir -p "$dir_path"

# í…œí”Œë¦¿ ê²½ë¡œ
template_path="$DOCS_DIR/00-09-System/01-Templates/$template"
if [[ ! -f "$template_path" ]]; then
  echo "Template not found: $template_path" >&2
  exit 1
fi

# í…œí”Œë¦¿ ë³µì‚¬ ë° ì¹˜í™˜
today=$(date +%Y-%m-%d)
# sed íŠ¹ìˆ˜ë¬¸ì ì´ìŠ¤ì¼€ì´í”„
escaped_title=$(echo "$title" | sed 's/[&/\]/\\&/g')
sed -e "s/{{CATEGORY}}/$cat_num/g" \
    -e "s/{{ID}}/$next_id/g" \
    -e "s/{{TITLE}}/$escaped_title/g" \
    -e "s/{{DATE}}/$today/g" \
    -e "s/{{CURRENT_DATE}}/$today/g" \
    "$template_path" > "$file_path"

# JDex ì—…ë°ì´íŠ¸ - í•´ë‹¹ ì¹´í…Œê³ ë¦¬ ì„¹ì…˜ ì°¾ì•„ì„œ í•­ëª© ì¶”ê°€
tmpfile=$(mktemp)
in_category=false
added=false

while IFS= read -r line; do
  echo "$line" >> "$tmpfile"

  # ì¹´í…Œê³ ë¦¬ í—¤ë” ê°ì§€: ### 21 ADR
  if [[ "$line" =~ ^###\ ([0-9]+)\  ]]; then
    current="${BASH_REMATCH[1]}"
    if [[ "$current" == "$cat_num" ]]; then
      in_category=true
    else
      in_category=false
    fi
  fi

  # í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ì£¼ì„ ë˜ëŠ” ë¹ˆ ì¤„ ë‹¤ìŒì— í•­ëª© ì¶”ê°€
  if [[ "$in_category" == true && "$added" == false ]]; then
    if [[ "$line" =~ ^"<!-- ì˜ˆ:" || "$line" =~ ^"<!--" || -z "$line" ]]; then
      echo "- $doc_id $title" >> "$tmpfile"
      added=true
    fi
  fi
done < "$jdex"

# ëê¹Œì§€ ì¶”ê°€ ëª»í–ˆìœ¼ë©´ íŒŒì¼ ëì— ì¶”ê°€
if [[ "$added" == false ]]; then
  echo "" >> "$tmpfile"
  echo "### $cat_num (new)" >> "$tmpfile"
  echo "- $doc_id $title" >> "$tmpfile"
fi

mv "$tmpfile" "$jdex"

echo "âœ… Created: $file_path"
echo "ğŸ“ JDex updated: $doc_id $title"
